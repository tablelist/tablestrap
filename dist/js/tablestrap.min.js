angular.module("tablestrap",[]),angular.module("tablestrap").directive("schedulePicker",["$parse",function(){return{restrict:"E",require:"ngModel",scope:{ngModel:"="},template:'<div class="schedule-picker clearfix"><div class="schedule-day clearfix" ng-repeat="scheduleDay in scheduleDays"><label><input type="checkbox" ng-checked="!scheduleDay.closed" ng-click="scheduleDay.select()"><span class="scheduleDay-name">{{ getDayFromNumber(scheduleDay.day) }}</span></label><div class="time-picker-range" ng-repeat="hoursRange in scheduleDay.hours"><div class="time-picker start-time" ng-class="{ error: hoursRange.invalidStartTime }"><select class="time-select" ng-model="hoursRange.startTime" ng-options="time for time in times"><option value="">Open</option></select><div class="meridian"><select ng-model="hoursRange.startMeridian" ng-options="period as period.name for period in periods"></select><i class="fa fa-chevron-down"></i></div></div><div class="splitter">-</div><div class="time-picker end-time" ng-class="{ error: hoursRange.invalidEndTime }"><select class="time-select" ng-model="hoursRange.endTime" ng-options="time for time in times"><option value="">Close</option></select><div class="meridian"><select ng-model="hoursRange.endMeridian" ng-options="period as period.name for period in periods"></select><i class="fa fa-chevron-down"></i></div></div><a class="time-picker-remove" href="#" ng-click="scheduleDay.removeHours($index)"><i class="fa fa-times"></i></a><div class="time-picker-disabled" ng-show="scheduleDay.closed" ng-click="scheduleDay.select()"></div></div><a class="time-picker-add" href="#" ng-click="scheduleDay.addHours()" ng-hide="scheduleDay.closed"><i class="fa fa-plus"></i></a></div></div>',link:function(e,i,r,s){function t(i){this.day=i,this.closed=!0,this.hours=[{startTime:null,startMeridian:e.periods[0],endTime:null,endMeridian:e.periods[1]}]}function a(e){var i=r.required;return i&&!e?s.$setValidity("required",!1):s.$setValidity("required",!0),n(),e}function n(){var i,r,t,a,n;for(i=0;i<e.scheduleDays.length;i++){var d=e.scheduleDays[i];if(d.validate(),!d.closed){if(!(d.closed||d.hours&&d.hours.length)){t=!0;break}if(d.hours&&d.hours.length)for(r=0;r<d.hours.length;r++){var l=d.hours[r];if(!(d.closed||l.startTime&&l.endTime)){t=!0,a=!0,n=!0;break}l.start=l.startTime+" "+l.startMeridian.name,l.end=l.endTime+" "+l.endMeridian.name}}}t?s.$setValidity("invalidRange",!1):s.$setValidity("invalidRange",!0),a?s.$setValidity("invalidStartTime",!1):s.$setValidity("invalidStartTime",!0),n?s.$setValidity("invalidEndTime",!1):s.$setValidity("invalidEndTime",!0)}function d(e,i){var r,s;for(3===i.length&&l(i,4),r=0;r<e.length;r++){var t=e[r];if(t===i){s=i;break}}return s}function l(e,i,r){return r=r||"0",e+="",e.length>=i?e:new Array(i-e.length+1).join(r)+e}e.periods=[{name:"AM"},{name:"PM"}];var o=new RegExp(/^\d{1,2}:\d{2}\s{1}.[amAMpmPM]$/);e.times=["12:00","12:30","1:00","1:30","2:00","2:30","3:00","3:30","4:00","4:30","5:00","5:30","6:00","6:30","7:00","7:30","8:00","8:30","9:00","9:30","10:00","10:30","11:00","11:30"],t.prototype.addHours=function(){var i=this;i.hours.push({startTime:null,startMeridian:e.periods[0],endTime:null,endMeridian:e.periods[1]})},t.prototype.select=function(){var e=this;e.closed=e.closed?!1:!0,e.reset()},t.prototype.removeHours=function(e){var i=this;1===i.hours.length?i.closed=!0:i.hours.splice(e,1),i.validate()},t.prototype.reset=function(){var e=this;console.log("reseting, day = "+e.day),e.hours=[],e.addHours()},t.prototype.validate=function(){var e=this;if(e.hours&&e.hours.length)for(var i=0;i<e.hours.length;i++){var r=e.hours[i];e.closed?(r.invalidStartTime=!1,r.invalidEndTime=!1,r.invalidRange=!1,r.startTime&&(r.startTime=null),r.endTime&&(r.endTime=null)):(r.invalidStartTime=r.startTime?!1:!0,r.invalidEndTime=r.endTime?!1:!0,r.invalidRange=r.invalidStartTime&&r.invalidEndTime?!0:!1)}},e.scheduleDays=[new t(1),new t(2),new t(3),new t(4),new t(5),new t(6),new t(0)],e.getDayFromNumber=function(e){switch(e){case 0:return"Sun";case 1:return"Mon";case 2:return"Tue";case 3:return"Wed";case 4:return"Thur";case 5:return"Fri";case 6:return"Sat";default:throw new Error("invalid day :"+e)}},e.$watch("scheduleDays",function(e){s.$setViewValue(angular.copy(e))},!0),s.$parsers.unshift(function(e){return a(e),e}),s.$formatters.push(function(i){var r,s;if(i&&i.length)for(r=0;r<i.length;r++){var t=i[r],a=0===t.day?6:t.day-1,n=e.scheduleDays[a];if(n&&(n.closed=t.closed,!n.closed&&t.hours&&t.hours.length))for(s=0;s<t.hours.length;s++){var l=t.hours[s],c=n.hours[s];if(!o.test(l.start))throw new Error(l.start+" is not in the format 09:00 AM");if(!o.test(l.end))throw new Error(l.end+" is not in the format 09:00 AM");var u=l.start.split(" ");c.startTime=d(e.times,u[0]),c.startMeridian="AM"===u[1]?e.periods[0]:e.periods[1];var h=l.end.split(" ");c.endTime=d(e.times,h[0]),c.endMeridian="AM"===h[1]?e.periods[0]:e.periods[1]}}return i})}}}]);